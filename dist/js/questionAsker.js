function guid(){function e(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return e()+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()+e()}function testSpeech(){var e=[];octopusTasks.getTasks().forEach(function(t,a){for(j=0;j<t.possibilities.length;j++)e.push(t.possibilities[j])});var t="#JSGF V1.0; grammar phrase; public <phrase> = ;",a=new SpeechRecognition,n=new SpeechGrammarList;n.addFromString(t,1),a.grammars=n,a.lang=octopusCharacter.getCurrentLanguage(),a.interimResults=!1,a.maxAlternatives=1,a.start(),a.onresult=function(e){var t=e.results[0][0].transcript,a=octopusTasks.checkTask(t.toLowerCase());console.log(t),viewCharacterResponse.renderTextResponse(a.response),viewTaskList.render(),viewCharacter.render(),soundPlayer.playCurrentSound(),null==a.feedback?viewFeedback.hideFeedbackDiv():viewFeedback.render(a.feedback)},a.onspeechend=function(){a.stop(),console.log("Stopped"),viewSpeakButton.restoreMic()},a.onerror=function(e){console.log("Error"+e.error),viewSpeakButton.restoreMic()}}function onSuccess(e){console.log("Audio enabled")}function onError(e){console.log("There was an error: "+e)}var SOUND_BASE_PATH="./static/audio/",IMAGE_BASE_PATH="./static/images/",bgIMAGE_BASE_PATH="./static/images/bg/",charTaskData=[],logDataTemplate={userID:"",dialogID:"",nodeID:"",timeStamp:"",eventType:"",response:""};logDataTemplate.userID=guid(),logDataTemplate.dialogID=0;var speechSynthData={rate:"",pitch:"",voice:"",name:""},startDemo={init:function(){demoLanguage?$.getJSON("./static/data/demo"+demoLanguage+".json",function(e){charTaskData=e,viewTaskList.init(),viewTaskList.render(),viewCharacter.init(),viewCharacterResponse.init(),viewCharacter.render(),viewSpeakButton.init(),viewSpeakButton.render(),viewCharList.init(),viewCharList.render(),soundPlayer.init(),viewSceneIntro.init(),viewSceneIntro.render(),viewFeedback.init(),window.speechSynthesis.onvoiceschanged=function(){speechSynth.init()}}):console.log("No Demo Language Loaded")}},octopusScene={getScenarioInfo:function(){return charTaskData.characterProfiles[charTaskData.currentCharacter].scenario}},octopusTasks={getTasks:function(){return charTaskData.characterProfiles[charTaskData.currentCharacter].tasks},allTasksCompletedBool:function(){return 0===charTaskData.characterProfiles[charTaskData.currentCharacter].tasks.length},completeTask:function(e){var t=octopusTasks.getTasks()[e];charTaskData.characterProfiles[charTaskData.currentCharacter].tasks.splice(e,1),charTaskData.characterProfiles[charTaskData.currentCharacter].completedTasks.push(t)},deleteTask:function(e){charTaskData.characterProfiles[charTaskData.currentCharacter].tasks.splice(e,1)},getCompletedTasks:function(){return charTaskData.characterProfiles[charTaskData.currentCharacter].completedTasks},completedTasksBool:function(){return charTaskData.characterProfiles[charTaskData.currentCharacter].completedTasks.length>0},taskHelp:function(e){var t=octopusTasks.getTasks()[e].possibilities[0];return t},getTaskLink:function(e){return null!==this.getTasks()[e].taskLink?this.getTasks()[e].taskLink:null},checkTask:function(e){var t=!1,a=0,n={response:"",feedback:""};octopusTasks.getTasks().forEach(function(r,s){for(j=0;j<r.possibilities.length;j++)if(r.possibilities[j].toLowerCase()==e){if(t=!0,a=r.dialogNodeID,n.response=r.response,n.feedback=null,r.correct=!0,charTaskData.currentEmotion=r.emotion,charTaskData.currentSoundID=r.soundID,null!==r.taskLink)var o=octopusTasks.getTaskLink(s);octopusTasks.completeTask(s),null!==r.taskType&&(console.log(r.taskType),"choice"==r.taskType&&octopusTasks.getTasks().forEach(function(e,t){e.taskLink==o&&octopusTasks.deleteTask(t)})),null==r.extensionTasks||r.extensionTasks.length>0&&r.extensionTasks.forEach(function(e,t){charTaskData.characterProfiles[charTaskData.currentCharacter].tasks.push(r.extensionTasks[t])})}});var r=logDataTemplate;if(r.timeStamp=new Date,r.nodeID=a,r.response=e,r.eventType="click",console.log(r),r=JSON.stringify(r),$.ajax({url:"/log",type:"POST",data:r,dataType:"json"}),t===!0)return n;charTaskData.currentEmotion=octopusCharacter.changeCurrentEmotion("confused");var s=charTaskData.characterProfiles[charTaskData.currentCharacter].confusedPhrases,o=Math.random();return n.response=s[Math.floor(o*s.length)].response,charTaskData.currentSoundID=s[Math.floor(o*s.length)].soundID,n.feedback=e,console.log(n.feedback),n},skipTasks:function(){var e=[];console.log(octopusTasks.getTasks().length),octopusTasks.getTasks().forEach(function(t,a){console.log(t),void 0===t.extensionTasks||t.extensionTasks.length>0&&t.extensionTasks.forEach(function(a,n){e.push(t.extensionTasks[n])}),console.log(e)}),charTaskData.characterProfiles[charTaskData.currentCharacter].tasks=e,viewTaskList.render()}},octopusCharacter={getCurrentLanguage:function(){return charTaskData.currentLanguage},setCurrentLanguage:function(){return charTaskData.currentLanguage=charTaskData.characterProfiles[charTaskData.currentCharacter].language,charTaskData.currentLanguage},getCharacters:function(){return charTaskData.characterProfiles},changeCharacter:function(e){charTaskData.currentCharacter=e},getCurrentCharacter:function(){return charTaskData.characterProfiles[charTaskData.currentCharacter]},getCurrentEmotion:function(){return charTaskData.currentEmotion},changeCurrentEmotion:function(e){return charTaskData.currentEmotion=e,e},getCurrentSceneBackground:function(){return bgIMAGE_BASE_PATH+charTaskData.characterProfiles[charTaskData.currentCharacter].location.bg}},octopusSound={getCurrentCharacterSounds:function(){var e=[],t=charTaskData.characterProfiles[charTaskData.currentCharacter].sounds;t.forEach(function(t,a){var n={soundID:t.soundID,soundPath:SOUND_BASE_PATH+t.soundPath};e.push(n)});var a=charTaskData.characterProfiles[charTaskData.currentCharacter].confusedPhrases;return a.forEach(function(t,a){var n={soundID:t.soundID,soundPath:SOUND_BASE_PATH+t.soundPath};e.push(n)}),e},getCurrentSoundID:function(){return charTaskData.currentSoundID},setCurrentSoundID:function(e){charTaskData.currentSoundID=e}},octopusSpeechSynth={setVoice:function(e){speechSynthData.voice=e},getVoice:function(){return speechSynthData.voice}},viewCharList={init:function(){this.charList=$(".charList")},render:function(){var e="";octopusCharacter.getCharacters().forEach(function(t,a){e+="<li class='charItem' data-index='"+a+"'>",e+="<a href='#'>"+t.name+"</a>",e+="</li>"}),this.charList.html(e),$(".charItem").click(function(){viewCharacterResponse.destroy(),octopusCharacter.changeCurrentEmotion("default");var e=$(this).attr("data-index");octopusCharacter.changeCharacter(e),viewCharacter.render(),viewTaskList.render(),viewSceneIntro.render(),soundPlayer.init()})}},viewTaskList={init:function(){this.taskList=$(".taskList"),this.completedTaskList=$(".completedTaskList"),this.modalWindowBody=$(".modal-body"),this.btnSkip=$(".btn-skip")},render:function(){if(octopusTasks.allTasksCompletedBool()===!1){var e="";octopusTasks.getTasks().forEach(function(t,a){e+="<li class='inactiveLink' role='presentation' data-index='"+a+"'>",e+="<div class='taskDiv'><span class='icon-mic'></span>",e+="<div class='taskText'>"+t.task+"</div>",e+="<a class='taskHelpIcon glyphicon glyphicon-question-sign' tabindex='0' role='button' data-trigger='click' data-toggle='popover' data-container='body' data-placement='bottom' data-content=' ' data-index='"+a+"'></a>",e+="</li>"}),this.taskList.html(e),$(".taskText").click(function(){$(this).parent().children(".icon-mic").attr("style","color: red"),testSpeech(),$(this).prop("disabled",!0)}),$(".taskHelpIcon").popover({}),$(".taskHelpIcon").on("shown.bs.popover",function(){var e=$(this).attr("data-index"),t="<div class='helpFillerText'> Maybe You Could Say: <span class='taskHelpSpeech'>"+octopusTasks.taskHelp(e)+"</span>";t+=' <span class="taskHelpSoundIcon glyphicon glyphicon glyphicon-volume-up" aria-hidden="true"></span>',$(".popover-content").html(t),$(".taskHelpSpeech, .taskHelpSoundIcon").click(function(){var e=$(".taskHelpSpeech").html();console.log(e),speechSynth.play(e)})})}else this.taskList.html("");this.btnSkip.unbind("click"),this.btnSkip.click(function(){octopusTasks.skipTasks()}),0===octopusTasks.getTasks().length&&this.btnSkip.addClass("hidden")}},viewCharacter={init:function(){this.characterDiv=$(".characterDiv"),this.characterNameDiv=$(".characterNameDiv"),this.characterImageDiv=$(".characterImageDiv"),this.bg=$(".sceneBG")},render:function(){currentChar=octopusCharacter.getCurrentCharacter(),currentEmotion=octopusCharacter.getCurrentEmotion(),octopusCharacter.setCurrentLanguage(),speechSynth.init(),this.characterImageDiv.html("<img class='charImage' src='"+IMAGE_BASE_PATH+currentChar.emotions[currentEmotion]+"'>"),this.characterNameDiv.html(currentChar.name),this.bg.attr("src",octopusCharacter.getCurrentSceneBackground())}},viewSceneIntro={init:function(){this.scenarioWindow=$(".scenarioWindow")},render:function(){var e=this;this.scenarioWindow.removeClass("hidden"),this.scenarioWindow.children(".scenarioHeader").html(octopusScene.getScenarioInfo().title),this.scenarioWindow.children(".scenarioText").html(octopusScene.getScenarioInfo().text),this.scenarioWindow.children(".btn-confirm").click(function(){e.scenarioWindow.addClass("hidden"),viewFadeAll.resetFade()}),viewFadeAll.render()}},viewCharacterResponse={init:function(){this.textResponse=$(".characterTextResponse")},renderTextResponse:function(e){this.textResponse.show(),this.textResponse.html(e)},destroy:function(){this.textResponse.hide()}},viewSpeakButton={init:function(){this.respondButton=$(".respondButton"),this.micIcon=$(".icon-mic")},render:function(){var e=this;this.respondButton.click(function(){e.micIcon.attr("style","color: red"),testSpeech(),e.respondButton.prop("disabled",!0)})},restoreMic:function(){this.micIcon.attr("style","color: #000098"),this.respondButton.prop("disabled",!1)}},viewFeedback={init:function(){this.feedback=$(".feedback")},render:function(e){this.feedback.removeClass("hidden"),this.feedback.html("I heard you say: <span class='feedbackText'>"+e+"</span>"),this.feedback.unbind("click"),this.feedback.click(function(){console.log($(this).children(".feedbackText").html()),speechSynth.play($(this).children(".feedbackText").html())})},hideFeedbackDiv:function(){this.feedback.hasClass("hidden")||(console.log("Hidden"),this.feedback.addClass("hidden"))}},soundPlayer={init:function(){var e=octopusSound.getCurrentCharacterSounds();e.forEach(function(e,t){createjs.Sound.registerSound(e.soundPath,e.soundID)})},playCurrentSound:function(){createjs.Sound.play(octopusSound.getCurrentSoundID()),console.log(octopusSound.getCurrentSoundID())}},speechSynth={init:function(){var e=window.speechSynthesis,t=[],a=octopusCharacter.getCurrentLanguage(),n="";"es-es"==a?n="Monica":(n="Google 普通话（中国大陆）",console.log(a)),console.log(n);var r=function(){for(t=e.getVoices(),i=0;i<t.length;i++)t[i].name===n&&octopusSpeechSynth.setVoice(t[i])};r()},play:function(e){var t=new SpeechSynthesisUtterance(e);console.log(octopusSpeechSynth.getVoice().name),t.voice=octopusSpeechSynth.getVoice(),t.rate=.8,console.log(t.voice),window.speechSynthesis.speak(t)}};try{var SpeechRecognition=SpeechRecognition||webkitSpeechRecognition,SpeechGrammarList=SpeechGrammarList||webkitSpeechGrammarList,SpeechRecognitionEvent=SpeechRecognitionEvent||webkitSpeechRecognitionEvent}catch(err){alert("Sorry, the browser does not support Web Speech. Please use Google Chrome for Speech Access.")}navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia;var mediaConstraints={audio:!0};navigator.getUserMedia(mediaConstraints,onSuccess,onError),startDemo.init(),$(function(){$('[data-toggle="popover"]').popover()});